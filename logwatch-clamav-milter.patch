Index: scripts/services/clamav-milter
===================================================================
RCS file: /var/cvs/logwatch/scripts/services/clamav-milter,v
retrieving revision 1.5
diff -u -r1.5 clamav-milter
--- scripts/services/clamav-milter	15 Feb 2005 14:15:26 -0000	1.5
+++ scripts/services/clamav-milter	4 Apr 2005 21:24:48 -0000
@@ -23,14 +23,21 @@
 
 while (defined($ThisLine = <STDIN>)) {
 
-   if (( $ThisLine =~ /^clamfi_abort/ ) or 
-       ( $ThisLine =~ /^clamfi_connect: not scanning outgoing messages/ ) or
-       ( $ThisLine =~ /^Quarantined infected mail as/ ) or
-       ( $ThisLine =~ /^Intercepted virus/)) {
-          # We do not care about these.
+   if (
+      ( $ThisLine =~ /^clamfi_abort/ ) or
+      ( $ThisLine =~ /^clamfi_connect: not scanning outgoing messages/ ) or
+      ( $ThisLine =~ /^Quarantined infected mail as/ ) or
+      ( $ThisLine =~ /^Intercepted virus/)
+   ) {
+      # We do not care about these.
    } elsif (($ThisLine =~ /clean message from/)) {
       $CleanMessage++;
-   } elsif ((($Virus) = ($ThisLine =~ /stream: (.*?) FOUND/i )) or (($Virus) = ($ThisLine =~ /^.+?msg\.\w+?: (.*?) FOUND/i ))) {
+   } elsif (
+      (($Virus) = ($ThisLine =~ /stream: (.*?) FOUND/i )) or
+      (($Virus) = ($ThisLine =~ /^.+?msg\.\w+?: (.*?) FOUND/i )) or
+      (($Virus) = ($ThisLine =~ /stream: (.*?) Intercepted virus from/i )) or
+      (($Virus) = ($ThisLine =~ /^[a-zA-Z0-9]+: [^ ]*: (.*?) Intercepted virus from/i ))
+   ) {
       $VirusList{$Virus}++;
    } elsif (($MailHost) = ($ThisLine =~ /^clamfi_connect: connection from (.*?)\n/i )) {
       $MailHostList{$MailHost}++;
@@ -39,6 +46,8 @@
    } elsif (($ClamdVersion, $MilterVersion) = ($ThisLine =~ /ClamAV version (.*?)\'?, clamav-milter version \'?(.*?)\'?\n/i )) {
       $Version = 'Clamd ver. ' . $ClamdVersion . ' / Clam-milter ver. ' . $MilterVersion; 
       $DaemonStart{$Version}++;
+   } elsif (($ChildLimit) = ($ThisLine =~ /hit max-children limit \((\d+ >= \d+)\): waiting for some to exit/)) {
+      $MaxChildrenLimit{$ChildLimit}++;
    } else {
       # Comment the following line if using verbose logging.
       # Note that doing that will result in not displaying the extra log.
@@ -46,28 +55,37 @@
    }
 }
 
+#############################################################
+
 if ($CleanMessage) {
-   print "\nClean messages: ". $CleanMessage." Message(s)\n";
+   print "\nClean messages: $CleanMessage Message(s)\n";
+}
+
+if (keys %MaxChildrenLimit) {
+   print "\nHit max-hildren limit:\n";
+   foreach $Limit (sort {$a cmp $b} keys %MaxChildrenLimit) {
+      print "   Limit $Limit children(s) exceeded $MaxChildrenLimit{$Limit} Time(s)\n"
+   }
 }
 
 if ((keys %VirusList)) {
    print "\nInfected messages:\n";
    foreach $Virus (sort {$a cmp $b} keys %VirusList) {
-      print '   ' . $Virus . ": ". $VirusList{$Virus} . " Message(s)\n";
+      print "   $Virus: $VirusList{$Virus} Message(s)\n";
    }
 }
 
 if ((keys %MailHostList) and ($Detail >= 5)) {
    print "\nHost list:\n";
    foreach $MailHost (sort {$a cmp $b} keys %MailHostList) {
-      print '   ' . $MailHost . ": ". $MailHostList{$MailHost} . " Time(s)\n";
+      print "   $MailHost: $MailHostList{$MailHost} Time(s)\n";
    }
 }
 
 if ((keys %DaemonStart) and ($Detail >= 5)) {
    print "\nAntivirus daemon:\n";
    foreach $Version (sort {$a cmp $b} keys %DaemonStart) {
-      print '   ' . $Version . ' started: '. $DaemonStart{$Version} . " Time(s)\n";
+      print "   $Version started: $DaemonStart{$Version} Time(s)\n";
    }
 }
 
@@ -77,3 +95,5 @@
 }
 
 exit(0);
+
+# vi: shiftwidth=3 tabstop=3 syntax=perl et
