Index: scripts/services/sshd
===================================================================
RCS file: /var/cvs/logwatch/scripts/services/sshd,v
retrieving revision 1.37
diff -u -r1.37 sshd
--- scripts/services/sshd	3 Feb 2004 19:13:14 -0000	1.37
+++ scripts/services/sshd	21 Jun 2004 22:11:31 -0000
@@ -56,23 +56,23 @@
    }
    chomp($ThisLine);
    if (
-       ($ThisLine =~ m/^(log: )?Closing connection to/) or
-       ($ThisLine =~ m/^Connection closed by/) or
        ($ThisLine =~ m/^(log: )?$/ ) or
        ($ThisLine =~ m/^(log: )?\^\[\[60G/ ) or
        ($ThisLine =~ m/^(log: )? succeeded$/ ) or
+       ($ThisLine =~ m/^(log: )?Closing connection to/) or
        ($ThisLine =~ m/^(log: )?Starting sshd:/ ) or
        ($ThisLine =~ m/^(log: )?sshd \-TERM succeeded/ ) or
-       ($ThisLine =~ m/^Disconnecting: Command terminated on signal \d+/) or
        ($ThisLine =~ m/^Bad protocol version identification .*:? [\d.]+/ ) or
        ($ThisLine =~ m/^Bad protocol version identification.*Big-Brother-Monitor/ ) or
-       ($ThisLine =~ m/Connection from .* port /) or
+       ($ThisLine =~ m/^Connection closed by/) or
+       ($ThisLine =~ m/^Disconnecting: Command terminated on signal \d+/) or
        ($ThisLine =~ m/^connect from \d+\.\d+\.\d+\.\d+/) or
-       ($ThisLine =~ m/Read from socket failed/) or
        ($ThisLine =~ m/^fatal: Timeout before authentication/ ) or
+       ($ThisLine =~ m/Connection from .* port /) or
+       ($ThisLine =~ m/Postponed keyboard-interactive for [^ ]+ from [^ ]+/) or
+       ($ThisLine =~ m/Read from socket failed/) or
        ($ThisLine =~ m/sshd startup\s+succeeded/) or
-       ($ThisLine =~ m/sshd shutdown\s+succeeded/) or
-       ($ThisLine =~ m/Postponed keyboard-interactive for [^ ]+ from [^ ]+/)
+       ($ThisLine =~ m/sshd shutdown\s+succeeded/)
    ) {
       # Ignore these
    } elsif ($ThisLine =~ /^Accepted (\S+) for (\S+) from ([\d\.:a-f]+) port (\d+)/) {
@@ -89,15 +89,15 @@
          print STDERR "DEBUG: Found -Failed login- line\n";
       }
       $BadLogins{"$2/$1 from $3"}++;
-   } elsif ( $ThisLine =~ m/^Failed (\S+) for illegal user (\S+) from ([^ ]+) port (\d+)/ ) { #openssh
+   } elsif ( $ThisLine =~ m/^Failed (\S+) for illegal user (.*) from ([^ ]+) port (\d+)/ ) { #openssh
       $Temp = "$2/$1 from $3";
       $BadLogins{$Temp}++;
       $IllegalUsers{$Temp}++;
    } elsif ( ($User) = ( $ThisLine =~ /Disconnecting: Too many authentication failures for ([^ ]+)/)) {
       $TooManyFailures{$User}++;
-   } elsif ( ($User) = ($ThisLine =~ /^input_userauth_request: illegal user ([^ ]+)$/ )) {
+   } elsif ( ($User) = ($ThisLine =~ /^input_userauth_request: illegal user (.*)$/ )) {
       $IllegalUsers{"$User/none from unknown"}++;
-   } elsif ( $ThisLine =~ m/^Illegal user (\S+) from ([^ ]+)/ ) { #redhat thing
+   } elsif ( $ThisLine =~ m/^Illegal user (.*) from ([^ ]+)/ ) { #redhat thing
       $IllegalUsers{"$1/none from $2"}++;
    } elsif ( $ThisLine =~ m/^(fatal: )?Did not receive ident(ification)? string from (.+)/ ) { # ssh/openssh
       $name = LookupIP($3);
@@ -151,6 +151,10 @@
       $NoRevMap{$ThisLine}++;
    } elsif ( ($Address) = ($ThisLine =~ /^reverse mapping checking getaddrinfo for ([^ ]*) failed - POSSIBLE BREAKIN ATTEMPT!/)) {
       $NoRevMap{$Address}++;
+   } elsif ( ($IP,$Address) = ($ThisLine =~ /^Address ([^ ]*) maps to ([^ ]*), but this does not map back to the address - POSSIBLE BREAKIN ATTEMPT!/)) {
+      $NoRevMap{"$Address($IP)"}++;
+   } elsif ( (undef,$Address) = ($ThisLine =~ /^warning: ([^ ]*), line \d+: can't verify hostname: getaddrinfo\(([^ ]*), AF_INET\) failed$/)) {
+      $NoRevMap{$Address}++;
    } elsif ( $ThisLine =~ m/subsystem request for sftp/ ) {
       $sftpRequests++;
    } elsif ( $ThisLine =~ m/refused connect from (.*)$/ ) {
@@ -169,6 +173,9 @@
       $TTYModesFail{$Reason}++;
    } elsif ( ($User,undef) = ($ThisLine =~ /^User ([^ ]*) not allowed because ([^ ]*) exists$/)) {
       $LoginLock{$User}++;
+   } elsif ( ($Method,$User,$Host) = ($ThisLine =~ /^Postponed ([^ ]*) for (illegal user [^ ]*|[^ ]*) from ([^ ]*) port \d+ ssh/)) {
+      $PostPonedAuth{"$User/$Method"}{$Host}++;
+      $IllegalUsers{"$User/$Method"}++;
    } elsif ( ($IP) = ($ThisLine =~ /^scanned from ([^ ]*)/) ) {
       push @Scanned, LookupIP($IP);
    } else {
@@ -263,6 +270,16 @@
    }
 }
 
+if (keys %PostPonedAuth) {
+   print "\nPostponed authentication:\n";
+   foreach $User (sort {$a cmp $b} keys %PostPonedAuth) {
+      print "   $User:\n";
+      foreach $Host (sort {$a cmp $b} keys %{$PostPonedAuth{$User}}) {
+         print "      $Host: $PostPonedAuth{$User}{$Host} Time(s)\n";
+      }
+   }
+}
+
 if (keys %Users) {
    print "\nUsers logging in through sshd:\n";
    foreach $user (sort {$a cmp $b} keys %Users) {
